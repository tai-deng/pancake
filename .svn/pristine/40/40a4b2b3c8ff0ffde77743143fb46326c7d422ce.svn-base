import WXCore from "../gamecore/wechat/WXCore";
import GameManager from "../gamecore/managers/GameManager";
import GameEventNames from "../GameEventNames";
import StateManage from "../StateManage/StateManage";

const {ccclass, property} = cc._decorator;

@ccclass
export default class TaskItem extends cc.Component {

    @property(cc.Label)
    taskName:cc.Label = null;
    @property(cc.Label)
    taskDetails:cc.Label = null;
    @property(cc.Label)
    plan:cc.Label = null;
    @property(cc.Node)
    progress:cc.Node = null;
    public itemTatus:object = {};
    // public itemData:object =null;


    //已领取按钮
    @property(cc.SpriteFrame)
    rewardedBtnSF:cc.SpriteFrame = null;
    

    itemIndex:number;

    onLoad () {

    }

    start () {
        this.init();
    }


    private _itemData:object;

    get itemData():object {
        return this._itemData;
    }

    set itemData(v:object) {
        if (this._itemData != v) {
            this._itemData = v;

            this.init();
        }
    }

    private init(){
        if (!this._isOnLoadCalled) return;

        if (!this._itemData) return;

        let data = this.itemData;
        this.taskName.string = data["title"];
        this.taskDetails.string = "奖励钻石"+data["awardNum"]+"颗";
        let planValue = StateManage.instance.getData(data["value"]);
        let temp = 0;
        if(planValue >= data["goal"]){
            cc.find("right/bottom/affirm",this.node).active = true;
            cc.find("right/bottom/playbar",this.node).active = false;
            temp = data["goal"];
            this.itemTatus["finish"] =1;
            this.itemTatus["gain"] = 2;
        }else{
            cc.find("right/bottom/affirm",this.node).active = false;
            cc.find("right/bottom/playbar",this.node).active = true;
            temp = planValue;
            this.itemTatus["finish"] =2;
        }
        
        if(this.node.name == "taskItem1"){
            if(StateManage.instance.getData(StateManage.KEY_ISGAINA) == 1){
                this.itemTatus["gain"] = 1
                cc.find("right/bottom/affirm",this.node).getComponent(cc.Sprite).spriteFrame = this.rewardedBtnSF;
            }
        }
        if(this.node.name == "taskItem2"){
            if(StateManage.instance.getData(StateManage.KEY_ISGAINB) == 1){
                this.itemTatus["gain"] = 1
                cc.find("right/bottom/affirm",this.node).getComponent(cc.Sprite).spriteFrame = this.rewardedBtnSF;
            }
        }
        if(this.node.name == "taskItem3"){
            if(StateManage.instance.getData(StateManage.KEY_ISGAINC) == 1){
                this.itemTatus["gain"] = 1
                cc.find("right/bottom/affirm",this.node).getComponent(cc.Sprite).spriteFrame = this.rewardedBtnSF;
            }
        }
        this.plan.string = temp + "/" + data["goal"];
        this.progress.width = (116/data["goal"]) * temp;
    }

    private refreshUI():void{

        if (this.itemTatus["gain"] == 1) {
            cc.find("right/bottom/affirm",this.node).getComponent(cc.Sprite).spriteFrame = this.rewardedBtnSF;
            WXCore.showToast("今天的任务已经做完了!")
        } else {
            cc.find("right/bottom/affirm",this.node).getComponent(cc.Sprite).spriteFrame.setTexture(cc.url.raw("resources/taskBtn.png"));
        }
        
    }

    /**
     * 任务状态 1 完成了    2 未完成    finish
     * 完成了   1 已领取    2 未领取    gain
     */
    // 完成任务获取指定奖励
    public affirmBtn(event:cc.Event):void{
        let script:TaskItem = this;
        if(this.itemTatus["gain"] == 2){
            let temp = StateManage.instance.getData(this.itemData["awardName"]) + this.itemData["awardNum"];
            StateManage.instance.setData(this.itemData["awardName"],temp);
            WXCore.showToast("完成任务获取"+this.itemData["awardNum"]+"钻石奖励!");
        }
        this.itemTatus["gain"] = 1;
        
        if(this.node.name == "taskItem1"){
            StateManage.instance.setData(StateManage.KEY_ISGAINA,1)
        }
        if(this.node.name == "taskItem2"){
            StateManage.instance.setData(StateManage.KEY_ISGAINB,1)
        }
        if(this.node.name == "taskItem3"){
            StateManage.instance.setData(StateManage.KEY_ISGAINC,1)
        }

        this.refreshUI();
    }
    // 开始游戏或者分享
    public playbarBtn(event:cc.Event):void{
        cc.log("开始游戏或者分享");
    }
    // 刷新任务
    public refresh(){
        let title:string = "";
        let script:TaskItem = this;
        let callback:Function = function(){};
        let taskNum = 0;
        if(this.node.name == "taskItem1"){
            taskNum = StateManage.instance.getData(StateManage.KEY_TASKNUMA);
        }
        if(this.node.name == "taskItem2"){
            taskNum = StateManage.instance.getData(StateManage.KEY_TASKNUMB);
        }
        if(this.node.name == "taskItem3"){
            taskNum = StateManage.instance.getData(StateManage.KEY_TASKNUMC);
        }
        if(taskNum > 0){
            title = "要观看一次广告来替换这个任务吗？";
            callback = function(label:string):void {
                cc.info(label)
                if (label == "ok") {
                    script.affirm(taskNum-1);
                }
                if(label == "off"){

                }
            }
        }else{
            title = "今天的任务刷新次数已使用完毕!";
        }
        GameManager.eventManager.dispatchEventWith(GameEventNames.SHOW_ALERT, [title, callback])
    }
    // 确认更新
    public affirm(num){
        console.log("----------------------")
        this.node.dispatchEvent(new cc.Event("getData", false))
        if(this.node.name == "taskItem1"){
            StateManage.instance.setData(StateManage.KEY_TASKNUMA,num);
        }
        if(this.node.name == "taskItem2"){
            StateManage.instance.setData(StateManage.KEY_TASKNUMB,num);
        }
        if(this.node.name == "taskItem3"){
            StateManage.instance.setData(StateManage.KEY_TASKNUMC,num);
        }
        this.init();
    }
    // update (dt) {}

}
