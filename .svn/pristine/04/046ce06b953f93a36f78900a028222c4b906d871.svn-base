"use strict";
cc._RF.push(module, '15469COGp5A0455pD4HJEei', 'TaskItem');
// Script/Task/TaskItem.ts

Object.defineProperty(exports, "__esModule", { value: true });
var WXCore_1 = require("../gamecore/wechat/WXCore");
var GameManager_1 = require("../gamecore/managers/GameManager");
var GameEventNames_1 = require("../GameEventNames");
var StateManage_1 = require("../StateManage/StateManage");
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property;
var TaskItem = /** @class */ (function (_super) {
    __extends(TaskItem, _super);
    function TaskItem() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.taskName = null;
        _this.taskDetails = null;
        _this.plan = null;
        _this.progress = null;
        _this.itemTatus = {};
        //已领取按钮
        _this.rewardedBtnSF = null;
        //未领取按钮
        _this.rewardedBtnNO = null;
        return _this;
        // update (dt) {}
    }
    TaskItem.prototype.onLoad = function () { };
    TaskItem.prototype.start = function () { };
    Object.defineProperty(TaskItem.prototype, "itemData", {
        get: function () {
            return this._itemData;
        },
        set: function (v) {
            if (this._itemData != v) {
                this._itemData = v;
                this.init();
            }
        },
        enumerable: true,
        configurable: true
    });
    // 初始化逻辑层
    TaskItem.prototype.init = function () {
        if (!this._isOnLoadCalled)
            return;
        if (!this._itemData)
            return;
        var data = this.itemData;
        var planValue = StateManage_1.default.instance.getData(data["value"]);
        this._itemIndex = this.node["itemIndex"];
        this._taskNum = StateManage_1.default.instance.getData("tasknum" + this._itemIndex);
        this._isGain = StateManage_1.default.instance.getData("isgaina" + this._itemIndex);
        if (planValue >= data["goal"]) {
            this._plan = data["goal"];
            this.itemTatus["finish"] = 1;
            if (this._isGain == 1) {
                this.itemTatus["gain"] = 1;
            }
            else if (this._isGain == 2) {
                this.itemTatus["gain"] = 2;
            }
            else if (this._isGain == 0) {
                StateManage_1.default.instance.setData("isgaina" + this._itemIndex, 2);
            }
        }
        else {
            this._plan = planValue;
            this.itemTatus["finish"] = 2;
        }
        this.refreshUI();
    };
    // 更新UI
    TaskItem.prototype.refreshUI = function () {
        var data = this.itemData;
        this.taskName.string = data["title"];
        this.taskDetails.string = "任务奖励：宝石×" + data["awardNum"];
        if (this.itemTatus["finish"] == 1) {
            cc.find("right/bottom/playbar", this.node).active = false;
            if (this.itemTatus["gain"] == 1) {
                cc.find("right/bottom/rewarded", this.node).active = true;
            }
            if (this.itemTatus["gain"] == 2) {
                cc.find("right/bottom/affirm", this.node).active = true;
            }
            cc.find("refresh", this.node).active = false;
        }
        if (this.itemTatus["finish"] == 2) {
            cc.find("right/bottom/rewarded", this.node).active = false;
            cc.find("right/bottom/affirm", this.node).active = false;
            cc.find("right/bottom/playbar", this.node).active = true;
            if (this._taskNum > 0) {
                cc.find("refresh", this.node).active = true;
            }
            else {
                cc.find("refresh", this.node).active = false;
            }
        }
        this.plan.string = this._plan + "/" + data["goal"];
        this.progress.width = (116 / data["goal"]) * this._plan;
    };
    /**
     * 完成任务获取指定奖励
     * 任务状态 1 完成了    2 未完成    finish
     * 完成了   1 已领取    2 未领取    gain
     */
    TaskItem.prototype.affirmBtn = function (event) {
        var script = this;
        if (this.itemTatus["gain"] == 2) {
            var temp = StateManage_1.default.instance.getData(this.itemData["awardName"]) + this.itemData["awardNum"];
            StateManage_1.default.instance.setData(this.itemData["awardName"], temp);
            WXCore_1.default.showToast("完成任务获取" + this.itemData["awardNum"] + "钻石奖励!");
        }
        this.itemTatus["gain"] = 1;
        StateManage_1.default.instance.setData("isgaina" + this._itemIndex, 1);
        this.refreshUI();
    };
    // 开始游戏或者分享
    TaskItem.prototype.playbarBtn = function (event) {
        cc.log("开始游戏或者分享");
    };
    // 刷新任务
    TaskItem.prototype.refresh = function () {
        var title = "";
        var script = this;
        var callback = function () { };
        cc.log(this._taskNum);
        if (this._taskNum > 0) {
            title = "要观看一次广告来替换这个任务吗？";
            callback = function (label) {
                cc.info(label);
                if (label == "ok") {
                    script.affirm();
                }
                if (label == "off") { }
            };
            GameManager_1.default.eventManager.dispatchEventWith(GameEventNames_1.default.SHOW_ALERT, [title, callback]);
        }
    };
    // 确认更新
    TaskItem.prototype.affirm = function () {
        this.node.dispatchEvent(new cc.Event("getData", false));
        StateManage_1.default.instance.setData("tasknum" + this._itemIndex, this._taskNum - 1);
        StateManage_1.default.instance.setData("isgaina" + this._itemIndex, 2);
        this.init();
    };
    __decorate([
        property(cc.Label)
    ], TaskItem.prototype, "taskName", void 0);
    __decorate([
        property(cc.Label)
    ], TaskItem.prototype, "taskDetails", void 0);
    __decorate([
        property(cc.Label)
    ], TaskItem.prototype, "plan", void 0);
    __decorate([
        property(cc.Node)
    ], TaskItem.prototype, "progress", void 0);
    __decorate([
        property(cc.SpriteFrame)
    ], TaskItem.prototype, "rewardedBtnSF", void 0);
    __decorate([
        property(cc.SpriteFrame)
    ], TaskItem.prototype, "rewardedBtnNO", void 0);
    TaskItem = __decorate([
        ccclass
    ], TaskItem);
    return TaskItem;
}(cc.Component));
exports.default = TaskItem;

cc._RF.pop();