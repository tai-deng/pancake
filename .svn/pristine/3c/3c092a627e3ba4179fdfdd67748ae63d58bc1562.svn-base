{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\Script\\gamecore\\managers/assets\\Script\\gamecore\\managers\\DataManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\Script\\gamecore\\managers","sourcesContent":["import Command from \"../legs/Command\";\nimport GameCoreEvent from \"../GameCoreEvent\";\nimport GameManager from \"./GameManager\";\n\n// Learn TypeScript:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/typescript.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\nconst {ccclass, property} = cc._decorator;\n\n/**\n * 数据管理器。可以通过该管理器管理全局数据。\n */\n@ccclass\nexport default class DataManager {\n    //字段名\n    private static L_KEY:string = \"__data_manager_local_v\";\n\n    /**\n     * 数据\n     */\n    private _data:object = {};\n\n    //保存到本地的数据\n    private _localData:object = {};\n\n    private _lastChangedKey:string;\n\n    constructor() {\n        this.unserialize();\n    }\n\n    /**\n     * 获取上次变化值的key值\n     */\n    public get lastChangedKey():string {\n        return this._lastChangedKey;\n    }\n\n\n    /**\n     * 设置全局数据。\n     * \n     * \n     * \n     * @param key               字段名\n     * @param value             字段值\n     * @param saveToLocal       是否保存到本地。如果保存到本地，字段值类型必须是简单类型，比如number、boolean、array\n     * @param justToday         日期变化后是否删除。该参数只有在saveToLocal参数为true的时候生效。\n     * \n     */\n    public setData(key:string, \n                   value:any, \n                   saveToLocal:boolean = false,\n                   justToday:boolean = false\n                ):void {\n        if (this._data[key] !== value) {\n            this._data[key] = value;\n\n            //保存到本地\n            if (saveToLocal) {\n                let data:object = {\"v\":value};\n                if (justToday) data[\"today\"] = GameManager.todayValue;\n\n                this._localData[key] = data;\n                this.serialize();\n            }\n\n            this._lastChangedKey = key;\n            GameManager.eventManager.dispatchEventWith(GameCoreEvent.DATA_CHANGE, key);\n        }\n\n        \n    }\n\n\n    /**\n     * 获取全局数据\n     * \n     * @param key \n     */\n    public getData(key:string):any {\n        return this._data[key];\n    }\n\n\n\n    /**\n     * 序列化数据\n     */\n    private serialize():void {\n        let v:string = JSON.stringify(this._localData);\n        cc.sys.localStorage.setItem(DataManager.L_KEY, v);\n    }\n\n\n    /**\n     * 反序列化\n     */\n    private unserialize():void {\n        try {\n            let v:string = cc.sys.localStorage.getItem(DataManager.L_KEY);\n            this._localData = JSON.parse(v);\n\n            if (!this._localData) this._localData = {};\n\n            //复制数据\n            for (let key in this._localData) {\n                //{\"v\":数据值, \"today\":日期值}\n                let data:object = this._localData[key];\n                let v:any = data[\"v\"];\n\n                let today:string = data[\"today\"];\n                //如果有设置隔日删除，则需要检查日期值\n                if (today && GameManager.todayValue == today) {\n                    this._data[key] = v;\n                }\n            }\n        } catch (err) {\n            this._localData = {};\n        }\n    }\n    \n\n}\n"]}