(function() {"use strict";var __module = CC_EDITOR ? module : {exports:{}};var __filename = 'preview-scripts/assets/Script/gamecore/managers/PopUpManager.js';var __require = CC_EDITOR ? function (request) {return cc.require(request, require);} : function (request) {return cc.require(request, __filename);};function __define (exports, require, module) {"use strict";
cc._RF.push(module, 'a385bbYdJpEPI+qXxNTQmtC', 'PopUpManager', __filename);
// Script/gamecore/managers/PopUpManager.ts

Object.defineProperty(exports, "__esModule", { value: true });
var TweenLite_1 = require("../libs/TweenLite");
var EasePack_1 = require("../libs/EasePack");
var GameManager_1 = require("./GameManager");
var GameCoreEvent_1 = require("../GameCoreEvent");
var WXCore_1 = require("../wechat/WXCore");
// Learn TypeScript:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/typescript.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html
// Learn Attribute:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html
// Learn life-cycle callbacks:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property;
var PopUpManager = /** @class */ (function (_super) {
    __extends(PopUpManager, _super);
    function PopUpManager() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        /**
         * {
         *      "uuid":[content, bg]
         *
         * }
         */
        _this._popUpMap = {};
        return _this;
    }
    /**
     * 创建背景
     */
    PopUpManager.prototype.createPopUpBg = function (alpha) {
        if (alpha === void 0) { alpha = 160; }
        var winSize = cc.director.getWinSize();
        var bg = new cc.Node();
        bg.width = winSize.width;
        bg.height = winSize.height;
        var ctx = bg.addComponent(cc.Graphics);
        ctx.fillColor = new cc.Color(0, 0, 0, alpha);
        // ctx.fillColor = cc.Color.RED;
        ctx.lineWidth = 0;
        ctx.fillRect(0, 0, winSize.width, winSize.height);
        ctx.stroke();
        // bg.color = cc.Color.BLACK;
        // bg.opacity = 30;
        bg.addComponent(cc.BlockInputEvents);
        return bg;
    };
    /**
     * 添加弹出面板。
     *
     * 弹出内容抛出GameCoreEvent.COMMON_CLOS事件时，会关闭面板。
     *
     * @param node                      弹出内容
     * @param modal                     是否禁用面板底层内容交互
     * @param closeWhenTapOutside       点击弹出内容外围是否关闭面板
     * @param scaleFactor               内容缩放因子。0.8表示内容会缩放至屏幕宽的0.8（或者高的0.8）
     * @param contentBgAlpha            内容背景透明度0-255
     */
    PopUpManager.prototype.addPopUp = function (node, modal, closeWhenTapOutside, scaleFactor, contentBgAlpha) {
        if (modal === void 0) { modal = true; }
        if (closeWhenTapOutside === void 0) { closeWhenTapOutside = false; }
        if (scaleFactor === void 0) { scaleFactor = 0.8; }
        if (contentBgAlpha === void 0) { contentBgAlpha = 160; }
        var udid = node.uuid;
        //记录数据
        this._popUpMap[udid] = [node, null];
        var winSize = cc.director.getWinSize();
        var bg = null;
        if (modal) {
            bg = this.createPopUpBg(contentBgAlpha);
            bg.y = winSize.height / 2;
            bg.x = winSize.width / 2;
            cc.director.getScene().addChild(bg);
            this._popUpMap[udid][1] = bg;
        }
        node.x = winSize.width / 2;
        node.y = winSize.height / 2;
        cc.director.getScene().addChild(node);
        var toScale = Math.min(winSize.width * scaleFactor / node.width, winSize.height * scaleFactor / node.height);
        node.scale = 0.5;
        TweenLite_1.TweenLite.to(node, 0.5, {
            "scale": toScale,
            "ease": EasePack_1.Back.easeOut,
            "onComplete": function () {
                //添加事件
                node.on(GameCoreEvent_1.default.COMMON_CLOSE, GameManager_1.default.popUpManager.nodeCloseEventHandler, GameManager_1.default.popUpManager);
                if (bg) {
                    bg.on(cc.Node.EventType.TOUCH_END, GameManager_1.default.popUpManager.popUpBgTapHandler, GameManager_1.default.popUpManager);
                }
            }
        });
        //添加事件
        // node.on(GameCoreEvent.COMMON_CLOSE, this.nodeCloseEventHandler, this);
        //播放音效
        GameManager_1.default.soundsManager.playSound(GameManager_1.default.soundsManager.popUpSoundSource);
        //微小震动
        if (GameManager_1.default.canVibrate) {
            WXCore_1.default.vibrateShort();
        }
    };
    /**
     * PopUp面板点击
     *
     * @param e
     */
    PopUpManager.prototype.popUpBgTapHandler = function (e) {
        var targetBG = e.currentTarget;
        for (var uuid in this._popUpMap) {
            //[content, bg]
            var v = this._popUpMap[uuid];
            if (v && v[1] == targetBG) {
                var content = v[0];
                if (content) {
                    content.dispatchEvent(new cc.Event(GameCoreEvent_1.default.COMMON_CLOSE, false));
                }
            }
        }
    };
    /**
     * node关闭事件控制
     *
     * @param evt
     */
    PopUpManager.prototype.nodeCloseEventHandler = function (evt) {
        var node = evt.currentTarget;
        this.removePopUp(node);
    };
    /**
     * 移除弹出
     *
     * @param node
     */
    PopUpManager.prototype.removePopUp = function (node) {
        if (!node)
            return;
        if (this._popUpMap[node.uuid]) {
            node.off(GameCoreEvent_1.default.COMMON_CLOSE, this.nodeCloseEventHandler);
            var bg = this._popUpMap[node.uuid][1];
            delete this._popUpMap[node.uuid];
            var obj = { "scale": node.scale, "opacity": node.opacity };
            TweenLite_1.TweenLite.to(obj, 0.3, {
                "scale": 0.5,
                "opacity": 0,
                "onUpdate": function (node, obj) {
                    if (node && node.parent) {
                        node.scale = obj["scale"];
                        node.opacity = obj["opacity"];
                    }
                },
                "onUpdateParams": [node, obj],
                "onComplete": function (node, bg) {
                    if (node && node.parent) {
                        node.removeFromParent();
                    }
                    if (bg && bg.parent) {
                        bg.removeFromParent();
                    }
                },
                "onCompleteParams": [node, bg]
            });
        }
    };
    PopUpManager = __decorate([
        ccclass
    ], PopUpManager);
    return PopUpManager;
}(cc.EventTarget));
exports.default = PopUpManager;

cc._RF.pop();
        }
        if (CC_EDITOR) {
            __define(__module.exports, __require, __module);
        }
        else {
            cc.registerModuleFunc(__filename, function () {
                __define(__module.exports, __require, __module);
            });
        }
        })();
        //# sourceMappingURL=PopUpManager.js.map
        