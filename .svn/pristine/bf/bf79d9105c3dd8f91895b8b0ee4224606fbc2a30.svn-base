import StateManage from "../StateManage/StateManage";
import Json from "../Json/Json";
import ShopMod from "./ShopMod";

const {ccclass, property} = cc._decorator;

@ccclass
export default class Shopping extends cc.Component {

    @property(cc.Node)
    potBtn:cc.Node = null;
    @property(cc.Node)
    cakeBtn:cc.Node = null;
    @property([cc.SpriteFrame])
    btnImg:Array<cc.SpriteFrame> = [];
    // 容器
    @property(cc.Node)
    container:cc.Node;

    // 弹窗节点
    // private toast:cc.Node = null;
    // 购买询问节点
    // private affirm:cc.Node = null;
    // 购买信息展示节点
    // private buyInfo:cc.Node = null;
    // 展示购买信息时间
    // private isTime:boolean = false;
    // private sumTime:number = 0;

    // 商品价格
    private price:number = null;
    // 商品项
    // @property(cc.Node)
    private itemHeight:number = 176;
    // onLoad () {}

    private getPotData(){
        let potData = ShopMod.instance.getPotList();
        this.ambry = potData;
    }
    private getCakeData(){
        let cakeData = ShopMod.instance.getCakeList();
        this.ambry = cakeData;
    }

    private _itemData:Array<object> = [];
    get ambry():Array<object> {
        return this._itemData;
    }
    set ambry(v:Array<object>) {
        if (this._itemData != v) {
            this._itemData = v;
            // 更新货架
            this.getData(this.ambry);
        }
    }

    private dataChanged(ev:cc.Event):void{
        cc.log(ev,"+++++++++")
    }
    // 锅皮肤按钮
    public potButton(){
        cc.log("锅皮肤")
        ShopMod.instance.isTab = true;

        StateManage.instance.setData(StateManage.KEY_SHOPING_TAB,1);
        this.getPotData();
    }
    // 饼皮肤按钮
    public cakeButton(){
        cc.log("饼皮肤");
        ShopMod.instance.isTab = false;

        StateManage.instance.setData(StateManage.KEY_SHOPING_TAB,2);
        // this.getCakeData();
        
        let cakeData = ShopMod.instance.getCakeList();
        this.ambry = cakeData;
    }

    start () {
        // 注册数据改变事件
        ShopMod.instance.on("dataChanged",this.dataChanged,this)
        this.getPotData();

        StateManage.instance.on("change",this.stateChangeHandler,this);
        StateManage.instance.setData(StateManage.KEY_SHOPING_TAB,1);
    }
    // 渲染商品
    private getData(goods:Array<object>){
        this.container.removeAllChildren();
        let goodNumber = goods.length;
        let row = Math.floor(goodNumber / 3) + (goodNumber % 3 == 0 ? 0 : 1);
        this.container.height = (this.itemHeight+14) * row + 14;
        for(let i = 0;i < goods.length; i++){
            cc.loader.loadRes("shopping/item", function(err, prefab){
                let item = cc.instantiate(prefab);
                item.getComponent("Goods").deploy = goods[i];
                this.container.addChild(item);
            }.bind(this));
        }
        cc.find("Canvas/shopping/scroll").getComponent(cc.ScrollView).scrollToTop(0.1)
    }
    // 初始化 item
    public initItem(goods:object,item:cc.Node){
        let gem = StateManage.instance.getData(StateManage.KEY_GEM);
        let id = goods['id'];
        let skinsRes = goods['skinsRes'];
        let price = goods['price'];
        let isBuy = goods['isBuy'];
        let isUse = goods['isUse'];
        let waitBuy = goods['waitBuy'];
        let newPro = goods['newPro'];
        /**
         * 1.已购买商品 使用中 和 未 使用
         * 2.未购买商品 解锁 和 未 解锁
         */
        if(isBuy == 1){
            if(isUse == 1){
                cc.find("use",item).active = false;
                cc.find("inUse",item).active = true;
                cc.find("price",item).active = false;
                cc.find("prop",item).active = true;
                cc.find("lock",item).active = false;
                cc.find("msk",item).active = false;
                if(newPro == 1){
                    cc.find("newPro",item).active = true;
                }else{
                    cc.find("newPro",item).active = false;
                }
                StateManage.instance.setData(StateManage.KEY_SKIN,skinsRes);
                cc.log(skinsRes,1)
            }
            if(isUse == 2){
                cc.find("use",item).active = true;
                cc.find("inUse",item).active = false;
                cc.find("price",item).active = false;
                cc.find("prop",item).active = true;
                cc.find("lock",item).active = false;
                cc.find("msk",item).active = false;
                if(newPro == 1){
                    cc.find("newPro",item).active = true;
                }else{
                    cc.find("newPro",item).active = false;
                }
            }
        }else if(isBuy == 2){
            if(waitBuy == 1){
                cc.find("use",item).active = false;
                cc.find("inUse",item).active = false;
                cc.find("price",item).active = true;
                cc.find("prop",item).active = true;
                cc.find("lock",item).active = false;
                cc.find("msk",item).active = true;
                if(gem >= price){
                    item.color = new cc.Color(17, 30, 131);
                }else{
                    item.color = new cc.Color(141, 22, 26);
                }
                if(newPro == 1){
                    cc.find("newPro",item).active = true;
                }else{
                    cc.find("newPro",item).active = false;
                }
            }else if(waitBuy == 2){
                cc.find("use",item).active = false;
                cc.find("inUse",item).active = false;
                cc.find("price",item).active = false;
                cc.find("prop",item).active = false;
                cc.find("lock",item).active = true;
                cc.find("msk",item).active = false;
                cc.find("newPro",item).active = false;
            }
        }
        cc.find("price/money",item).getComponent(cc.Label).string = price;
        item.getComponent("Goods")["deploy"] = goods;
    }
    // 状态监听
    public stateChangeHandler(){
        let key:string = StateManage.instance.lastChangedKey;
        // 1.锅按钮 2.饼按钮 3.事件完成
        if(key == StateManage.KEY_SHOPING_TAB){
            if(StateManage.instance.shoppingTab == 1){
                this.potBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[1];
                this.cakeBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[0];
            }
            if(StateManage.instance.shoppingTab == 2){
                this.potBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[0];
                this.cakeBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[1];
            }
            StateManage.instance.setData(StateManage.KEY_SHOPING_TAB,3);
        }
        if(key == StateManage.KEY_GEM){
            let gem = StateManage.instance.getData(StateManage.KEY_GEM);
            cc.find("Canvas/pageTop/score/Label").getComponent(cc.Label).string = gem;
        }
    }
    // 购买新皮肤
    public shopping(event, customEventData){
        cc.log("购买",event.target.parent)
        this.price = Number(cc.find("money",event.target.parent).getComponent(cc.Label).string);
        // this.toast = cc.find("Canvas/toast");
        // this.affirm = cc.find("content/affirm",this.toast);
        // this.buyInfo = cc.find("content/buyInfo",this.toast);

        // this.toast.active = true;
        // this.affirm.active = true;
        // this.buyInfo.active = false;
    }
    // update (dt) {}
    onDestroy() {
        // 页面退出时保持用户使用信息
        ShopMod.instance.updateData();

        StateManage.instance.off("change", this.stateChangeHandler);
    }
}
