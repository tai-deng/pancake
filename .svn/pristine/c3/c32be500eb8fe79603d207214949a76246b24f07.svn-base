import StateManage from "../StateManage/StateManage";
import WXCore from "../gamecore/wechat/WXCore";
import GameManager from "../gamecore/managers/GameManager";
import GameEventNames from "../GameEventNames";
import ShopMod from "./ShopMod";

const { ccclass, property } = cc._decorator;

@ccclass
export default class Goods extends cc.Component {
    // 配置
    // public deploy:object = null;
    private sumShop: Array<cc.Node> = null;
    private shopPrice: number = null;

    @property(cc.Label)
    price: cc.Label = null;
    @property(cc.Node)
    use: cc.Node;
    @property(cc.Node)
    useIn: cc.Node;
    @property(cc.Node)
    priceNode: cc.Node;
    @property(cc.Node)
    lock: cc.Node;
    @property(cc.Node)
    shopPic: cc.Node;
    @property(cc.Node)
    newPro: cc.Node

    private _itemData: object;
    get deploy(): object {
        return this._itemData;
    }
    set deploy(v: object) {
        if (this._itemData != v) {
            this._itemData = v;
            this.initialize();
        }
    }
    // 渲染 UI
    private initialize() {
        let data = this.deploy;
        for (const key in data) {
            cc.log(this,"`````````````````````")

            if (key == "price") {
                this.price.getComponent(cc.Label).string = data[key];
            }
            // 买了 或者 使用了
            if (data["isBuy"]) {
                this.shopPic.active = true;
                this.newPro.active = false;
                this.lock.active = false;
                this.priceNode.active = false;
                if (data["isUse"]) {
                    this.useIn.active = true;
                    this.use.active = false;
                } else {
                    this.useIn.active = false;
                    this.use.active = true;
                }
            } else if (data["waitBuy"]) {
                this.shopPic.active = true;
                this.newPro.active = true;
                this.lock.active = false;
                this.priceNode.active = true;
                this.useIn.active = false;
                this.use.active = false;
            } else {
                this.shopPic.active = false;
                this.newPro.active = false;
                this.lock.active = true;
                this.priceNode.active = false;
                this.useIn.active = false;
                this.use.active = false;
            }
        }
    }
    // 取消购买
    public cancelBuy(event, customEventData) {
        cc.log("取消购买");
    }
    // 确认购买
    public affirmBuy(trade:object) {
        let myGem = StateManage.instance.getData(StateManage.KEY_GEM);
        let shopPrice = Number(trade["price"])
        let showInfo = '';
        
        if (myGem >= shopPrice) {
            cc.log("购买成功", shopPrice,ShopMod.instance.isTab)
            let surplus = myGem - shopPrice;
            StateManage.instance.setData(StateManage.KEY_GEM, surplus);

            showInfo = "购买成功，同时解锁了新购买项！";
            let isTab = ShopMod.instance.isTab;
            if(isTab){
                ShopMod.instance.buyShopPot();
            }else{
                ShopMod.instance.buyShopCake();
            }

        } else {
            showInfo = "宝石不足";
            cc.log("购买失败", shopPrice)
        }
        WXCore.showToast(showInfo)
    }
    // onLoad () {
    // }

    start() {
        this.node.on(cc.Node.EventType.TOUCH_END, this.onTap, this.node)
    }
    private onTap(ev: cc.Event) {
        cc.log(ev)
        let targetNode = ev.target.getComponent("Goods");
        targetNode.tapItem(targetNode.deploy);
    }
    // item 按钮
    public tapItem(targetNode: object): void {
        // 是否是已购买的    是否是使用中的
        if (targetNode["isBuy"]) {
            if (targetNode["isUse"]) {
                WXCore.showToast("皮肤已在使用中");
            } else {
                targetNode["isUse"] = true;
                WXCore.showToast("使用成功!")
                // StateManage.instance.setData(StateManage.KEY_SKIN,this.deploy.skinsRes);
            }
            // 是否是解锁的
        } else {
            if (targetNode["waitBuy"]) {
                let title: string = "确认购买?";
                let script: Goods = this;
                let callback: Function = function (label: string): void {
                    cc.info(label)
                    if (label == "ok") {
                        script.affirmBuy(targetNode);
                    }
                    if (label == "off") { }
                }
                GameManager.eventManager.dispatchEventWith(GameEventNames.SHOW_ALERT, [title, callback])
                // StateManage.instance.setData(StateManage.KEY_TRADE,this.deploy);

            } else {
                WXCore.showToast("购买上一个皮肤后解锁")
            }
        }
        // this.initialize();
    }

    // update (dt) {}
}
