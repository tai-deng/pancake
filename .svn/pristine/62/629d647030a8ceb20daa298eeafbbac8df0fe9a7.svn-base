import GameManager from "../gamecore/managers/GameManager";
import StateManage from "../StateManage/StateManage";
import WXRewardVideoAd from "../gamecore/wechat/WXRewardVideoAd";
import WXCore from "../gamecore/wechat/WXCore";
import WXEventType from "../gamecore/wechat/WXEventType";
import GameCoreEvent from "../gamecore/GameCoreEvent";
import XYJAPI from "../gamecore/xiaoyaoji/XYJAPI";


const {ccclass, property} = cc._decorator;
/**
 * 展示游戏结果
 */
@ccclass
export default class GameOverPanelMain extends cc.Component {

    //播放视频广告
    @property(cc.Node)
    playVideoAdBtn:cc.Node = null;

    //再来一次
    @property(cc.Node)
    playAgainBtn:cc.Node = null;

    //使用复活卡
    @property(cc.Node)
    userCardBtn:cc.Node = null;


    //分数显示
    @property(cc.Label)
    scoreLabel:cc.Label = null;


    start() {
        let score:number = StateManage.instance.getData(StateManage.KEY_SCORE);
        this.scoreLabel.string = "" + score;

        this.playAgainBtn.on(cc.Node.EventType.TOUCH_END, this.playAgainBtnTapHandler, this);
        this.playVideoAdBtn.on(cc.Node.EventType.TOUCH_END, this.playVideoAdBtnTapHandler, this);
        this.userCardBtn.on(cc.Node.EventType.TOUCH_END, this.userCardBtnBtnTapHandler, this);

        this.schedule(this.checkTime, 1, 10000);
    }


    private _passedTime:number = 0;

    /**
     * 检查时间
     */
    private checkTime():void {
        if (WXRewardVideoAd.isPlaying) return;

        this._passedTime++;
        if (this._passedTime > 6) {
            //进入小排行榜场景
            cc.director.loadScene("indexScene");
        }
    }

    /**
     * 点击在来一次
     * 
     * @param e 
     */
    private playAgainBtnTapHandler(e:cc.Event):void {
        GameManager.soundsManager.playTapSound();

        cc.director.loadScene("gameScene");
    }

    /**
     * 点击播放视频
     * 
     * @param e 
     */
    private playVideoAdBtnTapHandler(e:cc.Event):void {
        GameManager.soundsManager.playTapSound();

        //检查是否广告是否可用
        if (WXRewardVideoAd.isReady) {
            WXCore.showToast("微信视频暂时无法展现!");
            return;
        }

        GameManager.eventManager.on(WXEventType.REWARD_VIDEO_AD_CLOSE, this.rewardVideoEventsHandler, this);
        GameManager.eventManager.on(WXEventType.REWARD_VIDEO_AD_ERROR, this.rewardVideoEventsHandler, this);
        GameManager.eventManager.on(WXEventType.REWARD_VIDEO_AD_COMPLETE, this.rewardVideoEventsHandler, this);
    }


    /**
     * 视频广告事件控制
     * 
     * @param e 
     */
    private rewardVideoEventsHandler(e:cc.Event):void {
        GameManager.eventManager.off(WXEventType.REWARD_VIDEO_AD_CLOSE, this.rewardVideoEventsHandler, this);
        GameManager.eventManager.off(WXEventType.REWARD_VIDEO_AD_ERROR, this.rewardVideoEventsHandler, this);
        GameManager.eventManager.off(WXEventType.REWARD_VIDEO_AD_COMPLETE, this.rewardVideoEventsHandler, this);

        if (e.type == WXEventType.REWARD_VIDEO_AD_COMPLETE) {
            //广告播放完成后，关闭面板，继续游戏
            this.resurrect();
        } else {
            this._passedTime = 3;
        }
    }

    /**
     * 点击复活卡
     * 
     * @param e 
     */
    private userCardBtnBtnTapHandler(e:cc.Event):void {
        GameManager.soundsManager.playTapSound();

        let script:GameOverPanelMain = this;
        if (XYJAPI.reviveCount > 1) {
            XYJAPI.useRevive(function(suc:boolean):void {
                if (suc) {
                    script.resurrect();
                } else {
                    this._passedTime = 3;
                }
            });
        } else {
            WXCore.showToast("无复活卡，赶紧去邀请好友吧~~~");
        }
    }




    /**
     * 复活
     */
    private resurrect():void {
        if (this._disposed) return;

        this.node.dispatchEvent(new cc.Event(GameCoreEvent.COMMON_CLOSE, false));
    }
    

    //是否已释放
    private _disposed:boolean;
    
    onDestroy() {
        this._disposed = true;

        this.unschedule(this.checkTime);
        // StateManage.instance.off("change", this.stateChangeHandler);
    }
}
