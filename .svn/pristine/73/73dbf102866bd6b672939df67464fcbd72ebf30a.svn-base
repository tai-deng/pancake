"use strict";
cc._RF.push(module, '6c0d5amoh9GAJ4/4ntC9utK', 'Shopping');
// Script/shopping/Shopping.ts

Object.defineProperty(exports, "__esModule", { value: true });
var StateManage_1 = require("../StateManage/StateManage");
var ShopMod_1 = require("./ShopMod");
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property;
var Shopping = /** @class */ (function (_super) {
    __extends(Shopping, _super);
    function Shopping() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.potBtn = null;
        _this.cakeBtn = null;
        _this.btnImg = [];
        // 弹窗节点
        // private toast:cc.Node = null;
        // 购买询问节点
        // private affirm:cc.Node = null;
        // 购买信息展示节点
        // private buyInfo:cc.Node = null;
        // 展示购买信息时间
        // private isTime:boolean = false;
        // private sumTime:number = 0;
        // 商品价格
        _this.price = null;
        // 商品项
        // @property(cc.Node)
        _this.itemHeight = 176;
        _this._itemData = [];
        return _this;
    }
    // onLoad () {}
    Shopping.prototype.getPotData = function () {
        var potData = ShopMod_1.default.instance.getPotList();
        this.ambry = potData;
    };
    Shopping.prototype.getCakeData = function () {
        var cakeData = ShopMod_1.default.instance.getCakeList();
        this.ambry = cakeData;
    };
    Object.defineProperty(Shopping.prototype, "ambry", {
        get: function () {
            return this._itemData;
        },
        set: function (v) {
            if (this._itemData != v) {
                this._itemData = v;
                // 更新货架
                this.getData(this.ambry);
            }
        },
        enumerable: true,
        configurable: true
    });
    Shopping.prototype.dataChanged = function (ev) {
        cc.log(ev, "+++++++++");
    };
    // 锅皮肤按钮
    Shopping.prototype.potButton = function () {
        cc.log("锅皮肤");
        ShopMod_1.default.instance.isTab = true;
        StateManage_1.default.instance.setData(StateManage_1.default.KEY_SHOPING_TAB, 1);
        this.getPotData();
    };
    // 饼皮肤按钮
    Shopping.prototype.cakeButton = function () {
        cc.log("饼皮肤");
        ShopMod_1.default.instance.isTab = false;
        StateManage_1.default.instance.setData(StateManage_1.default.KEY_SHOPING_TAB, 2);
        // this.getCakeData();
        var cakeData = ShopMod_1.default.instance.getCakeList();
        this.ambry = cakeData;
    };
    Shopping.prototype.start = function () {
        // 注册数据改变事件
        ShopMod_1.default.instance.on("dataChanged", this.dataChanged, this);
        this.getPotData();
        StateManage_1.default.instance.on("change", this.stateChangeHandler, this);
        StateManage_1.default.instance.setData(StateManage_1.default.KEY_SHOPING_TAB, 1);
    };
    // 渲染商品
    Shopping.prototype.getData = function (goods) {
        this.container.removeAllChildren();
        var goodNumber = goods.length;
        var row = Math.floor(goodNumber / 3) + (goodNumber % 3 == 0 ? 0 : 1);
        this.container.height = (this.itemHeight + 14) * row + 14;
        var _loop_1 = function (i) {
            cc.loader.loadRes("shopping/item", function (err, prefab) {
                var item = cc.instantiate(prefab);
                item.getComponent("Goods").deploy = goods[i];
                this.container.addChild(item);
            }.bind(this_1));
        };
        var this_1 = this;
        for (var i = 0; i < goods.length; i++) {
            _loop_1(i);
        }
        cc.find("Canvas/shopping/scroll").getComponent(cc.ScrollView).scrollToTop(0.1);
    };
    // 初始化 item
    Shopping.prototype.initItem = function (goods, item) {
        var gem = StateManage_1.default.instance.getData(StateManage_1.default.KEY_GEM);
        var id = goods['id'];
        var skinsRes = goods['skinsRes'];
        var price = goods['price'];
        var isBuy = goods['isBuy'];
        var isUse = goods['isUse'];
        var waitBuy = goods['waitBuy'];
        var newPro = goods['newPro'];
        /**
         * 1.已购买商品 使用中 和 未 使用
         * 2.未购买商品 解锁 和 未 解锁
         */
        if (isBuy == 1) {
            if (isUse == 1) {
                cc.find("use", item).active = false;
                cc.find("inUse", item).active = true;
                cc.find("price", item).active = false;
                cc.find("prop", item).active = true;
                cc.find("lock", item).active = false;
                cc.find("msk", item).active = false;
                if (newPro == 1) {
                    cc.find("newPro", item).active = true;
                }
                else {
                    cc.find("newPro", item).active = false;
                }
                StateManage_1.default.instance.setData(StateManage_1.default.KEY_SKIN, skinsRes);
                cc.log(skinsRes, 1);
            }
            if (isUse == 2) {
                cc.find("use", item).active = true;
                cc.find("inUse", item).active = false;
                cc.find("price", item).active = false;
                cc.find("prop", item).active = true;
                cc.find("lock", item).active = false;
                cc.find("msk", item).active = false;
                if (newPro == 1) {
                    cc.find("newPro", item).active = true;
                }
                else {
                    cc.find("newPro", item).active = false;
                }
            }
        }
        else if (isBuy == 2) {
            if (waitBuy == 1) {
                cc.find("use", item).active = false;
                cc.find("inUse", item).active = false;
                cc.find("price", item).active = true;
                cc.find("prop", item).active = true;
                cc.find("lock", item).active = false;
                cc.find("msk", item).active = true;
                if (gem >= price) {
                    item.color = new cc.Color(17, 30, 131);
                }
                else {
                    item.color = new cc.Color(141, 22, 26);
                }
                if (newPro == 1) {
                    cc.find("newPro", item).active = true;
                }
                else {
                    cc.find("newPro", item).active = false;
                }
            }
            else if (waitBuy == 2) {
                cc.find("use", item).active = false;
                cc.find("inUse", item).active = false;
                cc.find("price", item).active = false;
                cc.find("prop", item).active = false;
                cc.find("lock", item).active = true;
                cc.find("msk", item).active = false;
                cc.find("newPro", item).active = false;
            }
        }
        cc.find("price/money", item).getComponent(cc.Label).string = price;
        item.getComponent("Goods")["deploy"] = goods;
    };
    // 状态监听
    Shopping.prototype.stateChangeHandler = function () {
        var key = StateManage_1.default.instance.lastChangedKey;
        // 1.锅按钮 2.饼按钮 3.事件完成
        if (key == StateManage_1.default.KEY_SHOPING_TAB) {
            if (StateManage_1.default.instance.shoppingTab == 1) {
                this.potBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[1];
                this.cakeBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[0];
            }
            if (StateManage_1.default.instance.shoppingTab == 2) {
                this.potBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[0];
                this.cakeBtn.getComponent(cc.Sprite).spriteFrame = this.btnImg[1];
            }
            StateManage_1.default.instance.setData(StateManage_1.default.KEY_SHOPING_TAB, 3);
        }
        if (key == StateManage_1.default.KEY_GEM) {
            var gem = StateManage_1.default.instance.getData(StateManage_1.default.KEY_GEM);
            cc.find("Canvas/pageTop/score/Label").getComponent(cc.Label).string = gem;
        }
    };
    // 购买新皮肤
    Shopping.prototype.shopping = function (event, customEventData) {
        cc.log("购买", event.target.parent);
        this.price = Number(cc.find("money", event.target.parent).getComponent(cc.Label).string);
        // this.toast = cc.find("Canvas/toast");
        // this.affirm = cc.find("content/affirm",this.toast);
        // this.buyInfo = cc.find("content/buyInfo",this.toast);
        // this.toast.active = true;
        // this.affirm.active = true;
        // this.buyInfo.active = false;
    };
    // update (dt) {}
    Shopping.prototype.onDestroy = function () {
        // 页面退出时保持用户使用信息
        ShopMod_1.default.instance.updateData();
        StateManage_1.default.instance.off("change", this.stateChangeHandler);
    };
    __decorate([
        property(cc.Node)
    ], Shopping.prototype, "potBtn", void 0);
    __decorate([
        property(cc.Node)
    ], Shopping.prototype, "cakeBtn", void 0);
    __decorate([
        property([cc.SpriteFrame])
    ], Shopping.prototype, "btnImg", void 0);
    __decorate([
        property(cc.Node)
    ], Shopping.prototype, "container", void 0);
    Shopping = __decorate([
        ccclass
    ], Shopping);
    return Shopping;
}(cc.Component));
exports.default = Shopping;

cc._RF.pop();