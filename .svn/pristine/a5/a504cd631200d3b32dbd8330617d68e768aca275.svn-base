"use strict";
cc._RF.push(module, 'a38d5Eiy5BKm5JdG9C4Evdc', 'XYJAPI');
// Script/gamecore/xiaoyaoji/XYJAPI.ts

Object.defineProperty(exports, "__esModule", { value: true });
var WXCore_1 = require("../wechat/WXCore");
var md5_1 = require("../libs/md5");
// Learn TypeScript:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/typescript.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html
// Learn Attribute:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html
// Learn life-cycle callbacks:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property;
if (typeof wx != "undefined") {
    wx.onShow(function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  wx.onShow  -");
        cc.info(res);
        var query = res["query"];
        //分享者id
        XYJAPI.inviterOpenID = query.openId;
        //分享者昵称
        XYJAPI.inviterNickname = query.nickname;
        //分享的时间戳（秒）
        XYJAPI.inviterTime = parseInt(query.time);
        if (isNaN(XYJAPI.inviterTime))
            XYJAPI.inviterTime = 0;
        //分享做什么
        XYJAPI.inviterAction = query.action;
        XYJAPI.inviterChannel = query.channel;
    });
}
/**
 * 小幺鸡api
 *
 * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/UNX8Vu1aN?password=wx
 */
var XYJAPI = /** @class */ (function () {
    function XYJAPI() {
    }
    XYJAPI_1 = XYJAPI;
    Object.defineProperty(XYJAPI, "userInfo", {
        get: function () { return XYJAPI_1._userInfo; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(XYJAPI, "userUnionID", {
        get: function () { return XYJAPI_1._userUnionID; },
        enumerable: true,
        configurable: true
    });
    /**
     * 初始化
     */
    XYJAPI.init = function () {
        if (XYJAPI_1._initialized)
            return;
        XYJAPI_1._initialized = true;
        cc.info("----  小幺鸡 API ----");
        cc.info("-  init   -");
        if (typeof wx == "undefined")
            return;
        wx.login({
            "success": XYJAPI_1.loginCallback,
        });
    };
    /**
     * 检查是否是接力
     *
     * @param       minDelay        多少秒内可接力。默认30秒
     */
    XYJAPI.checkCanRelay = function (minDelay) {
        if (minDelay === void 0) { minDelay = 30; }
        if (!XYJAPI_1.userOpenID)
            return false;
        var query = WXCore_1.default.queryData;
        if (!query)
            return false;
        //分享者id
        XYJAPI_1.inviterOpenID = query.openId;
        //分享者昵称
        XYJAPI_1.inviterNickname = query.nickname;
        //分享的时间戳（秒）
        XYJAPI_1.inviterTime = parseInt(query.time);
        if (isNaN(XYJAPI_1.inviterTime))
            XYJAPI_1.inviterTime = 0;
        //分享做什么
        XYJAPI_1.inviterAction = query.action;
        XYJAPI_1.inviterChannel = query.channel;
        if (XYJAPI_1.userOpenID == XYJAPI_1.inviterOpenID) {
            cc.info("不能给自己接力");
            return false;
        }
        if (XYJAPI_1.inviterTime <= 0)
            return false;
        var nowS = Math.round(new Date().getTime() / 1000);
        if ((nowS - XYJAPI_1.inviterTime) > minDelay) {
            cc.info("接力间隔为" + (nowS - XYJAPI_1.inviterTime));
            return false;
        }
        if (XYJAPI_1.inviterAction != "relay")
            return false;
        return true;
    };
    /**
     * 用户的登陆回调
     *
     *
     * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/MsJg6RxLg
     *
     * @param res
     */
    XYJAPI.loginCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  loginCallback   -");
        cc.info(res);
        if (res) {
            XYJAPI_1._code = res["code"];
            XYJAPI_1.login();
        }
    };
    /**
     * 登陆平台
     */
    XYJAPI.login = function () {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  login   -");
        if (typeof wx == "undefined")
            return;
        cc.info("request Ball.Api.Auth.WechatLogin");
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Auth.WechatLogin",
            data: {
                code: "" + XYJAPI_1._code,
                opId: "" + XYJAPI_1.inviterOpenID,
                channel: "" + XYJAPI_1.inviterChannel,
            },
            header: {
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "POST",
            success: XYJAPI_1.loginFeedbackCallback,
            fail: function (res) {
                cc.info("failed to call Ball.Api.Auth.WechatLogin");
                cc.info(res);
            }
        });
    };
    /**
     * 向小幺鸡平台发送登陆反馈后回调
     */
    XYJAPI.loginFeedbackCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  loginFeedbackCallback   -");
        cc.info(res);
        XYJAPI_1.userOpenID = res["data"].data.openid;
        XYJAPI_1.userToken = res["data"].data.token;
        cc.info("userOpenID=" + XYJAPI_1.userOpenID);
        cc.info("userToken=" + XYJAPI_1.userToken);
        XYJAPI_1.getUserInfo();
    };
    /**
     * 获取用户信息
     */
    XYJAPI.getUserInfo = function () {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getUserInfo   -");
        //检查是否存在该数据
        if (XYJAPI_1._userInfo)
            return;
        if (typeof wx == "undefined")
            return;
        wx.getUserInfo({
            "success": XYJAPI_1.getUserInfoCallback
        });
    };
    /**
     * 获取用户信息回调
     * @param res
     */
    XYJAPI.getUserInfoCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getUserInfoCallback   -");
        cc.info(res);
        XYJAPI_1.encryptedData = res["encryptedData"];
        XYJAPI_1.iv = res["iv"];
        XYJAPI_1._userInfo = res["userInfo"];
        cc.info("encryptedData=" + XYJAPI_1.encryptedData);
        cc.info("iv=" + XYJAPI_1.iv);
        cc.info("userInfo=", XYJAPI_1._userInfo);
        //登录绑定unionid
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Auth.Binding",
            data: {
                encryptedData: XYJAPI_1.encryptedData,
                iv: XYJAPI_1.iv,
            },
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "POST",
            "success": XYJAPI_1.loginBindingCallback
        });
    };
    /**
     * 登陆绑定
     *
     * @param res
     */
    XYJAPI.loginBindingCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  loginBindingCallback   -");
        cc.info(res);
        XYJAPI_1._userUnionID = res["data"].data.unionId;
        cc.info("userUnionID=" + XYJAPI_1._userUnionID);
        //绑定成功后，获取复活卡数目
        XYJAPI_1.getRevive();
        //获取是否可分享并获得复活卡
        XYJAPI_1.getRemoteCanShare();
        //获取公众号二维码图片信息
        XYJAPI_1.getWXMiniAppData();
        //获取分享的数据
        XYJAPI_1.getShareData();
    };
    Object.defineProperty(XYJAPI, "canShare", {
        /**
         * 是否可以分享。
         */
        get: function () {
            return XYJAPI_1._r_canShare;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取远程设置的是否可分享的值
     */
    XYJAPI.getRemoteCanShare = function () {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getRemoteCanShare  -");
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.AppSet",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.AppSet ----");
                cc.info(res);
                if (res["data"] && res["data"].data) {
                    XYJAPI_1._r_canShare = (res["data"].data.status == 1);
                    cc.info("分享是否已开启" + XYJAPI_1._r_canShare);
                }
            },
        });
    };
    Object.defineProperty(XYJAPI, "reviveCount", {
        /**
         * 获取复活卡数量
         */
        get: function () {
            return this._reviveCount;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取复活卡数量。回调方法接收一个number类型的参数。
     */
    XYJAPI.getRevive = function (callback) {
        if (callback === void 0) { callback = null; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getRevive  -");
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.GetRevive",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.GetRevive ----");
                cc.info(res);
                XYJAPI_1._reviveCount = res.data.data.revive;
                cc.info("用户剩余的复活卡" + XYJAPI_1._reviveCount);
                if (callback != null) {
                    callback.call(null, XYJAPI_1._reviveCount);
                }
            },
        });
    };
    /**
     * 使用复活卡
     *
     * @param callback
     */
    XYJAPI.useRevive = function (callback) {
        if (callback === void 0) { callback = null; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  userRevive  -");
        if (XYJAPI_1._reviveCount <= 0) {
            cc.info("复活卡数量不足");
            return;
        }
        //减少一个复活卡
        XYJAPI_1._reviveCount--;
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.SetRevive",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.SetRevive ----");
                cc.info(res);
                var suc = (res && res["data"] && res["data"].code == 200);
                if (callback != null) {
                    callback.call(null, suc);
                }
            },
        });
    };
    /**
     * 保存分数
     *
     * @param score
     */
    XYJAPI.saveScore = function (score) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  saveScore  -");
        cc.info(score);
        if (!XYJAPI_1._userInfo) {
            cc.info("需要先登录才能调用该接口");
            return;
        }
        if (typeof wx == "undefined")
            return;
        cc.info("-  data  -");
        cc.info({ score: "" + score, headimg: XYJAPI_1._userInfo["avatarUrl"], nickname: XYJAPI_1._userInfo["nickName"], });
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.SaveScore",
            data: {
                score: "" + score,
                headimg: XYJAPI_1._userInfo["avatarUrl"],
                nickname: XYJAPI_1._userInfo["nickName"],
            },
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "POST",
            success: function (res) {
                cc.info("---- Ball.Api.Share.SaveScore ----");
                cc.info(res);
            },
        });
    };
    //{"imageurl":string, "title":string}
    // private static _shareData:object;
    /**
     * 获取分享数据
     *
     * @param callback      接受一个object对象:
     *
     * {"imageurl":string, "title":string}
     *
     */
    XYJAPI.getShareData = function (callback, status) {
        if (callback === void 0) { callback = null; }
        if (status === void 0) { status = 0; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getShareData  -");
        cc.info("status=" + status);
        if (XYJAPI_1._shareDataMap[status]) {
            if (callback != null) {
                callback.call(null, XYJAPI_1._shareDataMap[status]);
            }
            return;
        }
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.Get",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            data: {
                "status": status
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.Get ----");
                cc.info(res);
                var data = res["data"]["data"];
                XYJAPI_1._shareDataMap[status] = data;
                if (data) {
                    if (callback != null) {
                        callback.call(null, data);
                    }
                    if (status == 0) {
                        WXCore_1.default.setOnShareAppMessage(data["title"], data["imageurl"], { "openId": XYJAPI_1.userOpenID, "channel": XYJAPI_1.inviterChannel });
                    }
                }
            },
            fail: function (res) {
                cc.info("---- Ball.Api.Share.Get FAIL ----");
                cc.info(res);
            }
        });
    };
    /**
     * 获取交叉推广图。接收一个obj参数。
     *
     * {
     *      imageurl: "https://ball.yz071.com/Upload/image/2018-06-06/P_15282657218141544.jpg ",
     *      title: "篮球大作战",
     *      bili: "4:3"
     * }
     *
     * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/Rif1Qd3cp
     */
    XYJAPI.getAdImageData = function (callback, refreshAgain) {
        if (refreshAgain === void 0) { refreshAgain = false; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getAdImage   -");
        //如果不是强制刷新数据，使用老数据
        if (!refreshAgain && XYJAPI_1._adImageData) {
            if (callback != null) {
                callback.call(null, XYJAPI_1._adImageData);
            }
            return;
        }
        if (typeof wx == "undefined")
            return;
        wx.request({
            "url": "https://ball.yz071.com/api/?do=Ball.Api.Share.Shunt",
            "data": {},
            "header": {
                "X-Source": XYJAPI_1.channelID,
            },
            "method": "GET",
            "success": function (res) {
                cc.info("---- Ball.Api.Share.Shunt ----");
                cc.info(res);
                if (res && res["data"]) {
                    //这里返回了很多图片，需要去一个比例最接近的尺寸
                    var images = res["data"].data;
                    if (!images || images.length == 0)
                        return;
                    var winSize = cc.director.getWinSize();
                    var currentHWV = winSize.height / winSize.width;
                    var minHWV = 100;
                    var minHWVObj = void 0;
                    for (var i = 0; i < images.length; i++) {
                        //{imageurl: "https://ball.yz071.com/Upload/image/2018-06-06/P_15282657218141544.jpg ", title: "篮球大作战", bili: "4:3"}
                        var imgObj = images[i];
                        var hwv = String(imgObj["bili"]).split(":");
                        var v = Math.abs(Number(hwv[0]) / Number(hwv[1]) - currentHWV);
                        cc.info("current hwv is " + v);
                        if (v < minHWV) {
                            minHWV = v;
                            minHWVObj = imgObj;
                        }
                    }
                    if (minHWVObj) {
                        XYJAPI_1._adImageData = minHWVObj;
                        callback.call(null, XYJAPI_1._adImageData);
                    }
                }
            }
        });
    };
    Object.defineProperty(XYJAPI, "wxMiniAppData", {
        /**
         * 微信小程序数据
         *
         * {"imageurl":string}
         */
        get: function () {
            if (XYJAPI_1._wxMiniAppData) {
                return XYJAPI_1._wxMiniAppData;
            }
            XYJAPI_1.getWXMiniAppData();
            return null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取微信小程序数据
     *
     *
     * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/VBHsTd2nE
     *
     *
     *
     */
    XYJAPI.getWXMiniAppData = function () {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getWXMiniAppData  -");
        cc.info("is requesting is" + XYJAPI_1._isGettingWXMiniAppData);
        if (XYJAPI_1._isGettingWXMiniAppData)
            return;
        if (typeof wx == "undefined")
            return;
        //标记正在请求数据
        XYJAPI_1._isGettingWXMiniAppData = true;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Erweima.GetMoney",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Erweima.GetMoney ----");
                cc.info(res);
                XYJAPI_1._wxMiniAppData = res["data"]["data"];
            },
            complete: function () {
                XYJAPI_1._isGettingWXMiniAppData = false;
            }
        });
    };
    //================================================================================================
    //接力逻辑
    //================================================================================================
    /**
     * 上报接力分数
     *
     *
     * @param score             接力分数
     * @param startTime         接力开始时间（玩家开始玩游戏时间），秒
     *
     *
     * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/5DA71JiTP
     */
    XYJAPI.saveRelayScore = function (score, startTime) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  saveRelayScore  -");
        cc.info(score, startTime);
        if (!XYJAPI_1._userInfo) {
            cc.info("需要先登录才能调用该接口");
            return;
        }
        var theData = {};
        //分数
        theData["score"] = "" + score;
        theData["headimg"] = XYJAPI_1._userInfo["avatarUrl"],
            theData["nickname"] = XYJAPI_1._userInfo["nickName"],
            theData["hid"] = XYJAPI_1.inviterOpenID;
        theData["stamp"] = XYJAPI_1.inviterTime;
        theData["startTime"] = "" + Math.floor(startTime.getTime() / 1000);
        theData["endTime"] = "" + Math.round(new Date().getTime() / 1000);
        //输出信息
        cc.info("the data is:", theData);
        var signValue = XYJAPI_1.createSign(theData);
        cc.info("sign is:" + signValue);
        cc.info("url is:" + "https://ball.yz071.com/api/?do=Ball.Api.Share.saveHelpScore" + "&sign=" + signValue);
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.saveHelpScore" + "&sign=" + signValue,
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            data: theData,
            method: "POST",
            success: function (res) {
                cc.info("---- Ball.Api.Share.saveHelpScore ----");
                cc.info(res);
            },
            complete: function () {
            }
        });
    };
    /**
     * 接力数据
     *
     *
     * @see Ball.Api.Room.Activity
     */
    XYJAPI.getRelayData = function (callback) {
        if (callback === void 0) { callback = null; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getRelayData  -");
        if (!XYJAPI_1._userInfo) {
            cc.info("需要先登录才能调用该接口");
            return;
        }
        //使用老数据
        if (XYJAPI_1._relayData && XYJAPI_1._relayEndDate) {
            var now = new Date();
            if (XYJAPI_1._relayData > now) {
                if (callback != null)
                    callback.call(null, XYJAPI_1._relayData);
            }
        }
        var theData = {};
        //输出信息
        cc.info("the data is:", theData);
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Room.Activity",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            data: theData,
            method: "POST",
            success: function (res) {
                cc.info("---- Ball.Api.Room.Activity ----");
                cc.info(res);
                var data = res["data"]["data"];
                XYJAPI_1._relayData = data;
                //结束时间
                if (data) {
                    var remaining = data["remaining"];
                    if (remaining && remaining["end_time"]) {
                        XYJAPI_1._relayEndDate = new Date(remaining["end_time"] * 1000);
                    }
                }
                if (callback != null)
                    callback.call(null, data);
            },
            complete: function () {
            }
        });
    };
    //================================================================================================
    //通用方法
    //================================================================================================
    /**
     * 创建签名
     */
    XYJAPI.createSign = function (data) {
        var keys = [];
        for (var key in data) {
            var v = data[key];
            if (v == undefined || v == "")
                continue;
            keys.push("" + key);
        }
        keys.sort();
        var sign = "";
        for (var i = 0; i < keys.length; i++) {
            var theKey = keys[i];
            if (i > 0)
                sign += "&";
            sign += "" + theKey + "=" + data[theKey];
        }
        //加上key（即渠道号）
        sign += "&key=" + XYJAPI_1.channelID;
        //计算md5
        sign = md5_1.md5(sign);
        //大写
        sign = sign.toUpperCase();
        return sign;
    };
    //渠道id
    XYJAPI.channelID = null;
    //版本号
    XYJAPI.gameVersion = null;
    //邀请者id
    XYJAPI.inviterOpenID = null;
    //邀请者昵称
    XYJAPI.inviterNickname = null;
    //分享时间戳(秒)
    XYJAPI.inviterTime = 0;
    //分享目标
    XYJAPI.inviterAction = null;
    //推广来源
    XYJAPI.inviterChannel = null;
    //接力限制时间（秒）。默认30秒，即用户分享30秒内可以被接力。
    XYJAPI.relayLimitedTime = 30;
    //用户open id
    XYJAPI.userOpenID = null;
    //用户昵称
    XYJAPI.userNickname = null;
    XYJAPI.userToken = null;
    XYJAPI.encryptedData = null;
    XYJAPI.iv = null;
    /**
     * avatarUrl	string	用户头像图片 url
     * city	        string	用户所在城市
     * country	    string	用户所在国家
     * gender	    number	用户性别
     * language	    string	显示 country province city 所用的语言
     * nickName	    string	用户昵称
     * openId	    string	用户 openId
     * province	    string	用户所在省份
     */
    XYJAPI._userInfo = null;
    XYJAPI._userUnionID = null;
    XYJAPI._reviveCount = 0;
    //从服务器获取的分享数据
    XYJAPI._shareDataMap = {};
    XYJAPI = XYJAPI_1 = __decorate([
        ccclass
    ], XYJAPI);
    return XYJAPI;
    var XYJAPI_1;
}());
exports.default = XYJAPI;

cc._RF.pop();