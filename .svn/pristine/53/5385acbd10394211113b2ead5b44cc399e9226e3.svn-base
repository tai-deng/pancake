{"version":3,"sources":["PopUpManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\Script\\gamecore\\managers","sourcesContent":["import { TweenLite } from \"../libs/TweenLite\";\r\nimport { Back } from \"../libs/EasePack\";\r\nimport GameManager from \"./GameManager\";\r\nimport GameCoreEvent from \"../GameCoreEvent\";\r\nimport WXCore from \"../wechat/WXCore\";\r\n\r\n// Learn TypeScript:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/typescript.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html\r\n// Learn Attribute:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\nconst {ccclass, property} = cc._decorator;\r\n\r\n@ccclass\r\nexport default class PopUpManager extends cc.EventTarget {\r\n\r\n    /**\r\n     * {\r\n     *      \"uuid\":[content, bg]\r\n     *      \r\n     * }\r\n     */\r\n    private _popUpMap:object = {};\r\n\r\n    /**\r\n     * 创建背景\r\n     */\r\n    private createPopUpBg(alpha:number = 160):cc.Node {\r\n        let winSize:cc.Size = cc.director.getWinSize();\r\n\r\n        let bg:cc.Node = new cc.Node();\r\n        bg.width = winSize.width;\r\n        bg.height = winSize.height;\r\n\r\n        var ctx:cc.Graphics = bg.addComponent(cc.Graphics);\r\n        ctx.fillColor = new cc.Color(0, 0, 0, alpha);\r\n        // ctx.fillColor = cc.Color.RED;\r\n        ctx.lineWidth = 0;\r\n        ctx.fillRect(0, 0, winSize.width, winSize.height);\r\n        ctx.stroke();\r\n        // bg.color = cc.Color.BLACK;\r\n        // bg.opacity = 30;\r\n        bg.addComponent(cc.BlockInputEvents);\r\n\r\n        return bg;\r\n    }\r\n\r\n    \r\n    \r\n    /**\r\n     * 添加弹出面板。\r\n     * \r\n     * 弹出内容抛出GameCoreEvent.COMMON_CLOS事件时，会关闭面板。\r\n     * \r\n     * @param node                      弹出内容\r\n     * @param modal                     是否禁用面板底层内容交互\r\n     * @param closeWhenTapOutside       点击弹出内容外围是否关闭面板\r\n     * @param scaleFactor               内容缩放因子。0.8表示内容会缩放至屏幕宽的0.8（或者高的0.8）\r\n     * @param contentBgAlpha            内容背景透明度0-255\r\n     */\r\n    addPopUp(node:cc.Node, \r\n             modal:boolean = true, \r\n             closeWhenTapOutside:boolean = false,\r\n             scaleFactor:number = 0.8,\r\n             contentBgAlpha:number = 160\r\n            ):void {\r\n        let udid:string = node.uuid;\r\n\r\n        //记录数据\r\n        this._popUpMap[udid] = [node, null];\r\n\r\n        let winSize:cc.Size = cc.director.getWinSize();\r\n\r\n        let bg:cc.Node = null;\r\n        if (modal) {\r\n            bg = this.createPopUpBg(contentBgAlpha);\r\n            bg.y = winSize.height / 2;\r\n            bg.x = winSize.width / 2;\r\n            cc.director.getScene().addChild(bg);\r\n\r\n            this._popUpMap[udid][1] = bg;\r\n        }\r\n\r\n        node.x = winSize.width / 2;\r\n        node.y = winSize.height / 2;\r\n        cc.director.getScene().addChild(node);\r\n\r\n        let toScale:number = Math.min(winSize.width * scaleFactor / node.width, winSize.height * scaleFactor / node.height);\r\n        node.scale = 0.5;\r\n\r\n        TweenLite.to(node, 0.5, {\r\n            \"scale\":toScale, \r\n            \"ease\":Back.easeOut,\r\n            \"onComplete\":function():void {\r\n                //添加事件\r\n                node.on(GameCoreEvent.COMMON_CLOSE, GameManager.popUpManager.nodeCloseEventHandler, GameManager.popUpManager);\r\n                \r\n                if (bg) {\r\n                    bg.on(cc.Node.EventType.TOUCH_END, GameManager.popUpManager.popUpBgTapHandler, GameManager.popUpManager);\r\n                }\r\n            }\r\n\r\n        });\r\n\r\n        //添加事件\r\n        // node.on(GameCoreEvent.COMMON_CLOSE, this.nodeCloseEventHandler, this);\r\n        \r\n        //播放音效\r\n        GameManager.soundsManager.playSound(GameManager.soundsManager.popUpSoundSource);\r\n\r\n        //微小震动\r\n        if (GameManager.canVibrate) {\r\n            WXCore.vibrateShort();\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * PopUp面板点击\r\n     * \r\n     * @param e \r\n     */\r\n    private popUpBgTapHandler(e:cc.Event):void {\r\n        let targetBG:cc.Node = e.currentTarget;\r\n\r\n        for (var uuid in this._popUpMap) {\r\n            //[content, bg]\r\n            let v = this._popUpMap[uuid];\r\n            if (v && v[1] == targetBG) {\r\n                let content:cc.Node = v[0];\r\n                if (content) {\r\n                    content.dispatchEvent(new cc.Event(GameCoreEvent.COMMON_CLOSE, false));\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * node关闭事件控制\r\n     * \r\n     * @param evt\r\n     */\r\n    private nodeCloseEventHandler(evt:cc.Event):void {\r\n        let node:cc.Node = evt.currentTarget as cc.Node;\r\n        this.removePopUp(node);\r\n    }\r\n    \r\n    \r\n    \r\n    /**\r\n     * 移除弹出\r\n     * \r\n     * @param node \r\n     */\r\n    removePopUp(node:cc.Node):void {\r\n        if (!node) return;\r\n\r\n        if (this._popUpMap[node.uuid]) {\r\n            node.off(GameCoreEvent.COMMON_CLOSE, this.nodeCloseEventHandler);\r\n\r\n            let bg:cc.Node = this._popUpMap[node.uuid][1];\r\n            delete this._popUpMap[node.uuid];\r\n\r\n            let obj:object = {\"scale\":node.scale, \"opacity\":node.opacity};\r\n            TweenLite.to(obj, 0.3, {\r\n                \"scale\":0.5, \r\n                \"opacity\":0, \r\n                \"onUpdate\":function(node:cc.Node, obj:object):void {\r\n                    if (node && node.parent) {\r\n                        node.scale = obj[\"scale\"];\r\n                        node.opacity = obj[\"opacity\"];\r\n                    }\r\n                },\r\n                \"onUpdateParams\":[node, obj],\r\n                \"onComplete\":function(node:cc.Node, bg:cc.Node):void {\r\n                    if (node && node.parent) {\r\n                        node.removeFromParent();\r\n                    }\r\n\r\n                    if (bg && bg.parent) {\r\n                        bg.removeFromParent();\r\n                    }\r\n                },\r\n                \"onCompleteParams\":[node, bg]\r\n            });\r\n        }\r\n\r\n    }\r\n\r\n\r\n}\r\n"]}