(function() {"use strict";var __module = CC_EDITOR ? module : {exports:{}};var __filename = 'preview-scripts/assets/Script/gamecore/xiaoyaoji/XYJAPI.js';var __require = CC_EDITOR ? function (request) {return cc.require(request, require);} : function (request) {return cc.require(request, __filename);};function __define (exports, require, module) {"use strict";
cc._RF.push(module, 'a38d5Eiy5BKm5JdG9C4Evdc', 'XYJAPI', __filename);
// Script/gamecore/xiaoyaoji/XYJAPI.ts

Object.defineProperty(exports, "__esModule", { value: true });
var WXCore_1 = require("../wechat/WXCore");
// Learn TypeScript:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/typescript.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html
// Learn Attribute:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html
// Learn life-cycle callbacks:
//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html
//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html
var _a = cc._decorator, ccclass = _a.ccclass, property = _a.property;
if (typeof wx != "undefined") {
    wx.onShow(function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  wx.onShow  -");
        cc.info(res);
        XYJAPI.inviterOpenID = res["query"].openId;
        XYJAPI.inviterChannel = res["query"].channel;
    });
}
/**
 * 小幺鸡api
 *
 * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/UNX8Vu1aN?password=wx
 */
var XYJAPI = /** @class */ (function () {
    function XYJAPI() {
    }
    XYJAPI_1 = XYJAPI;
    /**
     * 初始化
     */
    XYJAPI.init = function () {
        if (XYJAPI_1._initialized)
            return;
        XYJAPI_1._initialized = true;
        cc.info("----  小幺鸡 API ----");
        cc.info("-  init   -");
        if (typeof wx == "undefined")
            return;
        wx.login({
            "success": XYJAPI_1.loginCallback,
        });
    };
    /**
     * 用户的登陆回调
     *
     *
     * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/MsJg6RxLg
     *
     * @param res
     */
    XYJAPI.loginCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  loginCallback   -");
        cc.info(res);
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Auth.WechatLogin",
            data: {
                code: "" + res["code"],
                opId: "" + XYJAPI_1.inviterOpenID,
                channel: "" + XYJAPI_1.inviterChannel,
            },
            header: {
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "POST",
            success: XYJAPI_1.loginFeedbackCallback
        });
    };
    /**
     * 向小幺鸡平台发送登陆反馈后回调
     */
    XYJAPI.loginFeedbackCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  loginFeedbackCallback   -");
        cc.info(res);
        XYJAPI_1.userOpenID = res["data"].data.openid;
        XYJAPI_1.userToken = res["data"].data.token;
        cc.info("userOpenID=" + XYJAPI_1.userOpenID);
        cc.info("userToken=" + XYJAPI_1.userToken);
        wx.getUserInfo({
            "success": XYJAPI_1.getUserInfoCallback
        });
    };
    /**
     * 获取用户信息回调
     * @param res
     */
    XYJAPI.getUserInfoCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getUserInfoCallback   -");
        cc.info(res);
        XYJAPI_1.encryptedData = res["encryptedData"];
        XYJAPI_1.iv = res["iv"];
        XYJAPI_1.userInfo = res["userInfo"];
        cc.info("encryptedData=" + XYJAPI_1.encryptedData);
        cc.info("iv=" + XYJAPI_1.iv);
        cc.info("userInfo=", XYJAPI_1.userInfo);
        if (typeof wx == "undefined")
            return;
        //登录绑定unionid
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Auth.Binding",
            data: {
                encryptedData: XYJAPI_1.encryptedData,
                iv: XYJAPI_1.iv,
            },
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "POST",
            "success": XYJAPI_1.loginBindingCallback
        });
    };
    /**
     * 登陆绑定
     *
     * @param res
     */
    XYJAPI.loginBindingCallback = function (res) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getUserInfoCallback   -");
        cc.info(res);
        XYJAPI_1.userUnionID = res["data"].data.unionId;
        cc.info("userUnionID=" + XYJAPI_1.userUnionID);
        //绑定成功后，获取复活卡数目
        XYJAPI_1.getRevive();
        //获取是否可分享并获得复活卡
        XYJAPI_1.getRemoteCanShare();
        //获取公众号二维码图片信息
        XYJAPI_1.getWXMiniAppData();
        //获取分享的数据
        XYJAPI_1.getShareData();
    };
    Object.defineProperty(XYJAPI, "canShare", {
        /**
         * 是否可以分享。
         */
        get: function () {
            return XYJAPI_1._r_canShare;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取远程设置的是否可分享的值
     */
    XYJAPI.getRemoteCanShare = function () {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getRemoteCanShare  -");
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.AppSet",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.AppSet ----");
                cc.info(res);
                if (res["data"] && res["data"].data) {
                    XYJAPI_1._r_canShare = (res["data"].data.status == 1);
                    cc.info("分享是否已开启" + XYJAPI_1._r_canShare);
                }
            },
        });
    };
    Object.defineProperty(XYJAPI, "reviveCount", {
        /**
         * 获取复活卡数量
         */
        get: function () {
            return this._reviveCount;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取复活卡数量。回调方法接收一个number类型的参数。
     */
    XYJAPI.getRevive = function (callback) {
        if (callback === void 0) { callback = null; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getRevive  -");
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.GetRevive",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.GetRevive ----");
                cc.info(res);
                XYJAPI_1._reviveCount = res.data.data.revive;
                cc.info("用户剩余的复活卡" + XYJAPI_1._reviveCount);
                if (callback != null) {
                    callback.call(null, XYJAPI_1._reviveCount);
                }
            },
        });
    };
    /**
     * 使用复活卡
     *
     * @param callback
     */
    XYJAPI.useRevive = function (callback) {
        if (callback === void 0) { callback = null; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  userRevive  -");
        if (XYJAPI_1._reviveCount <= 0) {
            cc.info("复活卡数量不足");
            return;
        }
        //减少一个复活卡
        XYJAPI_1._reviveCount--;
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.SetRevive",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.SetRevive ----");
                cc.info(res);
                var suc = (res && res["data"] && res["data"].code == 200);
                if (callback != null) {
                    callback.apply(null, suc);
                }
            },
        });
    };
    /**
     * 保存分数
     *
     * @param score
     */
    XYJAPI.saveScore = function (score) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  saveScore  -");
        cc.info(score);
        if (typeof wx == "undefined")
            return;
        cc.info("-  data  -");
        cc.info({ score: "" + score, headimg: XYJAPI_1.userInfo["avatarUrl"], nickname: XYJAPI_1.userInfo["nickName"], });
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.SaveScore",
            data: {
                score: "" + score,
                headimg: XYJAPI_1.userInfo["avatarUrl"],
                nickname: XYJAPI_1.userInfo["nickName"],
            },
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "POST",
            success: function (res) {
                cc.info("---- Ball.Api.Share.SaveScore ----");
                cc.info(res);
            },
        });
    };
    /**
     * 获取分享数据
     *
     * @param callback      接受一个object对象:
     *
     * {"imageurl":string, "title":string}
     *
     */
    XYJAPI.getShareData = function (callback) {
        if (callback === void 0) { callback = null; }
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getShareData  -");
        if (XYJAPI_1._shareData) {
            if (callback != null) {
                callback.call(null, XYJAPI_1._shareData);
            }
            return;
        }
        if (typeof wx == "undefined")
            return;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Share.Get",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Share.Get ----");
                cc.info(res);
                XYJAPI_1._shareData = res["data"]["data"];
                if (XYJAPI_1._shareData) {
                    if (callback != null) {
                        callback.call(null, XYJAPI_1._shareData);
                    }
                    WXCore_1.default.setOnShareAppMessage(XYJAPI_1._shareData["title"], XYJAPI_1._shareData["imageurl"], "openId=" + XYJAPI_1.userOpenID + "&channel=" + XYJAPI_1.channelID);
                }
            },
        });
    };
    /**
     * 获取交叉推广图
     *
     * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/Rif1Qd3cp
     */
    XYJAPI.getAdImage = function (callback) {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getAdImage   -");
        if (typeof wx == "undefined")
            return;
        wx.request({
            "url": "https://ball.yz071.com/api/?do=Ball.Api.Share.Shunt",
            "data": {},
            "header": {
                "X-Source": XYJAPI_1.channelID,
            },
            "method": "GET",
            "success": function (res) {
                cc.info("---- Ball.Api.Share.Shunt ----");
                cc.info(res);
                if (res && res["data"]) {
                    //这里返回了很多图片，需要去一个比例最接近的尺寸
                    var images = res["data"].data;
                    if (!images || images.length == 0)
                        return;
                    var winSize = cc.director.getWinSize();
                    var currentHWV = winSize.height / winSize.width;
                    var minHWV = 100;
                    var minHWVObj = void 0;
                    for (var i = 0; i < images.length; i++) {
                        //{imageurl: "https://ball.yz071.com/Upload/image/2018-06-06/P_15282657218141544.jpg ", title: "篮球大作战", bili: "4:3"}
                        var imgObj = images[i];
                        var hwv = String(imgObj["bili"]).split(":");
                        var v = Math.abs(Number(hwv[0]) / Number(hwv[1]) - currentHWV);
                        cc.info("current hwv is " + v);
                        if (v < minHWV) {
                            minHWV = v;
                            minHWVObj = imgObj;
                        }
                    }
                    if (minHWVObj) {
                        callback.call(null, minHWVObj);
                    }
                }
            }
        });
    };
    Object.defineProperty(XYJAPI, "wxMiniAppData", {
        /**
         * 微信小程序数据
         *
         * {"imageurl":string}
         */
        get: function () {
            if (XYJAPI_1._wxMiniAppData) {
                return XYJAPI_1._wxMiniAppData;
            }
            XYJAPI_1.getWXMiniAppData();
            return null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取微信小程序数据
     *
     *
     * @see http://www.xiaoyaoji.cn/share/MsmrbiWWx/VBHsTd2nE
     *
     *
     *
     */
    XYJAPI.getWXMiniAppData = function () {
        cc.info("----  小幺鸡 API ----");
        cc.info("-  getWXMiniAppData  -");
        cc.info("is requesting is" + XYJAPI_1._isGettingWXMiniAppData);
        if (XYJAPI_1._isGettingWXMiniAppData)
            return;
        if (typeof wx == "undefined")
            return;
        //标记正在请求数据
        XYJAPI_1._isGettingWXMiniAppData = true;
        wx.request({
            url: "https://ball.yz071.com/api/?do=Ball.Api.Erweima.GetMoney",
            header: {
                "X-Token": XYJAPI_1.userToken,
                "X-Version": XYJAPI_1.gameVersion,
                "X-Source": XYJAPI_1.channelID,
            },
            method: "GET",
            success: function (res) {
                cc.info("---- Ball.Api.Erweima.GetMoney ----");
                cc.info(res);
                XYJAPI_1._wxMiniAppData = res["data"]["data"];
            },
            complete: function () {
                XYJAPI_1._isGettingWXMiniAppData = false;
            }
        });
    };
    //渠道id
    XYJAPI.channelID = null;
    //版本号
    XYJAPI.gameVersion = null;
    //邀请者id
    XYJAPI.inviterOpenID = null;
    //来源渠道
    XYJAPI.inviterChannel = null;
    XYJAPI.userToken = null;
    XYJAPI.userOpenID = null;
    XYJAPI.encryptedData = null;
    XYJAPI.iv = null;
    /**
     * avatarUrl	string	用户头像图片 url
     * city	        string	用户所在城市
     * country	    string	用户所在国家
     * gender	    number	用户性别
     * language	    string	显示 country province city 所用的语言
     * nickName	    string	用户昵称
     * openId	    string	用户 openId
     * province	    string	用户所在省份
     */
    XYJAPI.userInfo = null;
    XYJAPI.userUnionID = null;
    XYJAPI._reviveCount = 0;
    XYJAPI = XYJAPI_1 = __decorate([
        ccclass
    ], XYJAPI);
    return XYJAPI;
    var XYJAPI_1;
}());
exports.default = XYJAPI;

cc._RF.pop();
        }
        if (CC_EDITOR) {
            __define(__module.exports, __require, __module);
        }
        else {
            cc.registerModuleFunc(__filename, function () {
                __define(__module.exports, __require, __module);
            });
        }
        })();
        //# sourceMappingURL=XYJAPI.js.map
        